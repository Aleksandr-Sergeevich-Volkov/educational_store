{% extends "base.html" %}
{% load django_bootstrap5 %}
{% load static %}

{% block title %}–î–æ—Å—Ç–∞–≤–∫–∞ –Ø–Ω–¥–µ–∫—Å{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1 class="mb-4">üöö –î–æ—Å—Ç–∞–≤–∫–∞ –Ø–Ω–¥–µ–∫—Å</h1>
    
    <div class="row">
        <div class="col-12 col-lg-8">
            <!-- –í–∏–¥–∂–µ—Ç –¥–æ—Å—Ç–∞–≤–∫–∏ -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">üìç –í—ã–±–µ—Ä–∏—Ç–µ –ø—É–Ω–∫—Ç –≤—ã–¥–∞—á–∏</h5>
                </div>
                <div class="card-body p-0">
                    <div id="delivery-widget"></div>
                </div>
            </div>
        </div>
        
        <div class="col-12 col-lg-4">
            <!-- –§–æ—Ä–º–∞ –≤—ã–±–æ—Ä–∞ -->
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="card-title mb-0">‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤—ã–±–æ—Ä–∞</h5>
                </div>
                <div class="card-body">
                    <form action="" method="get" class="order-form">
                        {% csrf_token %}
                        <div class="mb-3">
                            {% bootstrap_form form %}
                        </div>
                        <button type="submit" class="btn btn-success w-100 py-2">
                            üìç –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ø—É–Ω–∫—Ç —Å–∞–º–æ–≤—ã–≤–æ–∑–∞
                        </button>
                    </form>
                    
                    {% if cost %}
                    <div class="mt-3 p-3 bg-light rounded">
                        <h6 class="mb-1">üí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å –¥–æ—Å—Ç–∞–≤–∫–∏:</h6>
                        <span class="fw-bold text-primary fs-5">{{ cost }} —Ä—É–±</span>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –°–∫—Ä–∏–ø—Ç –≤–∏–¥–∂–µ—Ç–∞ –¥–æ—Å—Ç–∞–≤–∫–∏ -->
<script async src="https://ndd-widget.landpro.site/widget.js"></script>
<script>
(function(w) {
    function startWidget() {
        w.YaDelivery.createWidget({
            containerId: 'delivery-widget',
            params: {
                city: "–•–∏–º–∫–∏",
                size: {
                    "height": "500px",
                    "width": "105%"
                },
                source_platform_station: "01978d0f333b73d680d32e7d696090e3",
                physical_dims_weight_gross: 10000,
                delivery_price: (price) => price + " —Ä—É–±",
                delivery_term: 3,
                show_select_button: true,
                filter: {
                    type: [
                        "pickup_point",
                        "terminal"
                    ],
                    is_yandex_branded: false,
                    payment_methods: [
                        "already_paid",
                        "card_on_receipt"
                    ],
                    payment_methods_filter: "or"
                }
            },
        });
    }
    w.YaDelivery
        ? startWidget()
        : document.addEventListener('YaNddWidgetLoad', startWidget);
})(window);

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –ø—É–Ω–∫—Ç–∞ –≤—ã–¥–∞—á–∏
document.addEventListener('YaNddWidgetPointSelected', function (data){
    console.log('–í—ã–±—Ä–∞–Ω –ü–í–ó:', data.detail.id);
    console.log('–ê–¥—Ä–µ—Å:', data.detail.address.full_address);
    
    // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è —Ñ–æ—Ä–º—ã
    document.getElementById('id_address_pvz').value = data.detail.address.full_address;
    document.getElementById('id_pvz_id').value = data.detail.id;
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    showNotification('–ü—É–Ω–∫—Ç –≤—ã–¥–∞—á–∏ –≤—ã–±—Ä–∞–Ω: ' + data.detail.address.full_address);
});

function showNotification(message) {
    // –°–æ–∑–¥–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    const notification = document.createElement('div');
    notification.className = 'alert alert-success alert-dismissible fade show';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // –î–æ–±–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ –Ω–∞—á–∞–ª–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    const container = document.querySelector('.container-fluid');
    container.insertBefore(notification, container.firstChild);
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 5000);
}
</script>

<style>
#delivery-widget {
    border-radius: 0.375rem;
    overflow: hidden;
}

.card {
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

@media (max-width: 768px) {
    .container-fluid {
        padding: 0 15px;
    }
    
    #delivery-widget {
        height: 400px !important;
    }
}
</style>
{% endblock %}