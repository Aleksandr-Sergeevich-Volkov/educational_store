{% extends "base.html" %}
{% load django_bootstrap5 %}
{% load static %}

{% block title %}–î–æ—Å—Ç–∞–≤–∫–∞ –°–î–≠–ö{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1 class="mb-4">üì¶ –î–æ—Å—Ç–∞–≤–∫–∞ –°–î–≠–ö</h1>
    
    <div class="row">
        <div class="col-12 col-lg-8">
            <div class="card mb-4">
                <div class="card-header bg-warning text-dark">
                    <h5 class="card-title mb-0">üìç –í—ã–±–µ—Ä–∏—Ç–µ –ø—É–Ω–∫—Ç –≤—ã–¥–∞—á–∏ –°–î–≠–ö</h5>
                </div>
                <div class="card-body">
                    <button onclick="openCdekWidget()" class="btn btn-warning btn-lg w-100 py-3 mb-3">
                        üó∫Ô∏è –û—Ç–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç—É –ü–í–ó –°–î–≠–ö
                    </button>
                    
                    <div class="alert alert-info">
                        <strong>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:</strong> –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –≤—ã—à–µ —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å –ø—É–Ω–∫—Ç –≤—ã–¥–∞—á–∏ –Ω–∞ –∫–∞—Ä—Ç–µ
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-12 col-lg-4">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="card-title mb-0">‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤—ã–±–æ—Ä–∞</h5>
                </div>
                <div class="card-body">
                    <form action="" method="get" class="order-form">
                        {% csrf_token %}
                        <div class="mb-3">
                            {% bootstrap_form form %}
                        </div>
                        
                        <button type="submit" class="btn btn-success w-100 py-3">
                            ‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ø—É–Ω–∫—Ç —Å–∞–º–æ–≤—ã–≤–æ–∑–∞
                        </button>
                    </form>
                </div>
            </div>
            
            <div class="card mt-3">
                <div class="card-header bg-primary text-white">
                    <h6 class="card-title mb-0">üìã –°—Ç–∞—Ç—É—Å</h6>
                </div>
                <div class="card-body">
                    <div id="status" class="text-muted small">
                        –û–∂–∏–¥–∞–Ω–∏–µ –≤—ã–±–æ—Ä–∞ –ø—É–Ω–∫—Ç–∞...
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- CDN –¥–ª—è –≤–∏–¥–∂–µ—Ç–∞ -->
<script src="https://cdn.jsdelivr.net/npm/@cdek-it/widget@3"></script>

<script>
let cdekWidget = null;

function initWidget() {
    try {
        cdekWidget = new CDEKWidget({
            from: '–ú–æ—Å–∫–≤–∞',
            root: 'widget-container',
            apiKey: '08505f2e-943d-4ed9-8195-1b5a2739c6a3',
            canChoose: true,
            servicePath: 'https://kompressionnye-chulki24.ru/service.php',
            popup: true,
            goods: [{
                width: 10,
                height: 10,
                length: 10,
                weight: 1
            }],
            defaultLocation: [37.6176, 55.7558],
            lang: 'rus',
            currency: 'RUB',
            onReady: function() {
                console.log('–í–∏–¥–∂–µ—Ç –≥–æ—Ç–æ–≤');
                document.getElementById('status').innerHTML = '‚úÖ –í–∏–¥–∂–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω';
            },
            onChoose: function(type, tariff, address) {
                console.log('–í—ã–±—Ä–∞–Ω –ø—É–Ω–∫—Ç:', address);
                
                // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É
                document.getElementById('id_sum').value = tariff.delivery_sum;
                document.getElementById('id_address_pvz').value = address.name;
                
                document.getElementById('status').innerHTML = 
                    '‚úÖ –í—ã–±—Ä–∞–Ω: ' + address.name + '<br>' +
                    'üíµ –°—Ç–æ–∏–º–æ—Å—Ç—å: ' + tariff.delivery_sum + ' —Ä—É–±.<br>' +
                    'üìÖ –°—Ä–æ–∫: ' + tariff.period_max + ' –¥–Ω.';
                
                alert('–ü—É–Ω–∫—Ç –≤—ã–±—Ä–∞–Ω: ' + address.name + '\n–°—Ç–æ–∏–º–æ—Å—Ç—å: ' + tariff.delivery_sum + ' —Ä—É–±.');
            },
            onError: function(error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                document.getElementById('status').innerHTML = '‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–∂–µ—Ç–∞';
            }
        });
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
        document.getElementById('status').innerHTML = '‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏';
    }
}

function openCdekWidget() {
    if (!cdekWidget) {
        initWidget();
        setTimeout(() => {
            if (cdekWidget && cdekWidget.open) {
                cdekWidget.open();
            }
        }, 1000);
    } else {
        cdekWidget.open();
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
document.addEventListener('DOMContentLoaded', function() {
    initWidget();
});
</script>
{% endblock %}