{% extends "base.html" %}
{% load django_bootstrap5 %}
{% load static %}

{% block title %}–î–æ—Å—Ç–∞–≤–∫–∞ –°–î–≠–ö{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1 class="mb-4">üì¶ –î–æ—Å—Ç–∞–≤–∫–∞ –°–î–≠–ö</h1>
    
    <div class="row">
        <div class="col-12 col-lg-8">
            <!-- –í–∏–¥–∂–µ—Ç –°–î–≠–ö -->
            <div class="card mb-4">
                <div class="card-header bg-warning text-dark">
                    <h5 class="card-title mb-0">üìç –í—ã–±–µ—Ä–∏—Ç–µ –ø—É–Ω–∫—Ç –≤—ã–¥–∞—á–∏ –°–î–≠–ö</h5>
                </div>
                <div class="card-body">
                    <p class="mb-3">–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç—É —Å –ø—É–Ω–∫—Ç–∞–º–∏ –≤—ã–¥–∞—á–∏ –∑–∞–∫–∞–∑–æ–≤ –°–î–≠–ö</p>
                    
                    <!-- –†–∞–±–æ—á–∞—è –∫–Ω–æ–ø–∫–∞ -->
                    <button onclick="window.widget.open()" class="btn btn-warning btn-lg w-100 py-3">
                        üó∫Ô∏è –û—Ç–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç—É –ü–í–ó –°–î–≠–ö
                    </button>
                    
                    <div class="alert alert-info mt-3 mb-0">
                        <strong>‚ÑπÔ∏è –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:</strong> –ü–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –ø—É–Ω–∫—Ç–∞ –Ω–∞ –∫–∞—Ä—Ç–µ –¥–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è—Ç—Å—è –≤ —Ñ–æ—Ä–º–µ —Å–ø—Ä–∞–≤–∞
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-12 col-lg-4">
            <!-- –§–æ—Ä–º–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è -->
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="card-title mb-0">‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤—ã–±–æ—Ä–∞</h5>
                </div>
                <div class="card-body">
                    <form action="" method="get" class="order-form">
                        {% csrf_token %}
                        <div class="mb-3">
                            {% bootstrap_form form %}
                        </div>
                        
                        <div class="alert alert-success small mb-3" style="display: none;" id="success-alert">
                            <strong>‚úÖ –£—Å–ø–µ—à–Ω–æ!</strong> –ü—É–Ω–∫—Ç –≤—ã–¥–∞—á–∏ –≤—ã–±—Ä–∞–Ω –∏ –¥–∞–Ω–Ω—ã–µ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã
                        </div>
                        
                        <button type="submit" class="btn btn-success w-100 py-3">
                            ‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ø—É–Ω–∫—Ç —Å–∞–º–æ–≤—ã–≤–æ–∑–∞
                        </button>
                    </form>
                </div>
            </div>
            
            <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤—ã–±–æ—Ä–µ -->
            <div class="card mt-3">
                <div class="card-header bg-primary text-white">
                    <h6 class="card-title mb-0">üìã –°—Ç–∞—Ç—É—Å –≤—ã–±–æ—Ä–∞</h6>
                </div>
                <div class="card-body">
                    <div id="selection-status" class="text-muted small">
                        –ü—É–Ω–∫—Ç –≤—ã–¥–∞—á–∏ –µ—â–µ –Ω–µ –≤—ã–±—Ä–∞–Ω
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–æ–≤ –°–î–≠–ö -->
<script src="https://cdn.jsdelivr.net/npm/@cdek-it/widget@3" type="text/javascript"></script>
<script src="https://cdn.jsdelivr.net/npm/@unocss/runtime" type="text/javascript"></script>
<link href="https://cdn.jsdelivr.net/npm/@unocss/reset/tailwind.min.css" rel="stylesheet">

<script type="text/javascript">
    document.addEventListener('DOMContentLoaded', () => {
        window.widget = new window.CDEKWidget({
            from: '–•–∏–º–∫–∏',
            root: 'cdek-map',
            apiKey: '08505f2e-943d-4ed9-8195-1b5a2739c6a3',
            canChoose: true,
            servicePath: 'https://kompressionnye-chulki24.ru/service.php',
            hideFilters: {
                have_cashless: false,
                have_cash: false,
                is_dressing_room: false,
                type: false,
            },
            hideDeliveryOptions: {
                office: false,
                door: true,
            },
            popup: true,
            debug: true,
            goods: [
                {
                    width: 10,
                    height: 10,
                    length: 10,
                    weight: 10,
                },
            ],
            defaultLocation: [37.4297, 55.897],
            lang: 'rus',
            currency: 'RUB',
            tariffs: {
                office: [234, 136],
                door: [234, 136, 138],
            },
            onReady() {
                console.log('‚úÖ –í–∏–¥–∂–µ—Ç –°–î–≠–ö –∑–∞–≥—Ä—É–∂–µ–Ω');
                updateStatus('–í–∏–¥–∂–µ—Ç –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ - –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "–û—Ç–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç—É –ü–í–ó –°–î–≠–ö"');
            },
            onCalculate() {
                console.log('üí∞ –†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –¥–æ—Å—Ç–∞–≤–∫–∏ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω');
            },
            onChoose(type, tariff, address) {
                console.log('üìç –í—ã–±—Ä–∞–Ω –º–µ—Ç–æ–¥ –¥–æ—Å—Ç–∞–≤–∫–∏', type, tariff, address);
                
                let message = '';
                if (type === 'door') {
                    message = '–í—ã–±—Ä–∞–Ω–∞ –¥–æ—Å—Ç–∞–≤–∫–∞ –∫—É—Ä—å–µ—Ä–æ–º –ø–æ –∞–¥—Ä–µ—Å—É: ' + address.formatted +
                            '\n–¶–µ–Ω–∞: ' + tariff.delivery_sum + ' —Ä—É–±.' +
                            '\n–°—Ä–æ–∫: ' + tariff.period_max + ' –¥–Ω.';
                } else {
                    message = '–í—ã–±—Ä–∞–Ω –ø—É–Ω–∫—Ç –≤—ã–¥–∞—á–∏ –∑–∞–∫–∞–∑–∞: ' + address.name +
                            '\n–¶–µ–Ω–∞: ' + tariff.delivery_sum + ' —Ä—É–±.' +
                            '\n–°—Ä–æ–∫: ' + tariff.period_max + ' –¥–Ω.';
                }
                
                // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É
                document.getElementById('id_sum').value = tariff.delivery_sum;
                document.getElementById('id_address_pvz').value = address.name;
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                showSuccessNotification();
                updateStatus('‚úÖ –ü—É–Ω–∫—Ç –≤—ã–±—Ä–∞–Ω: ' + address.name);
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º alert (–∫–∞–∫ –≤ —Ä–∞–±–æ—á–µ–π –≤–µ—Ä—Å–∏–∏)
                alert(message);
            },
            onError(error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –≤–∏–¥–∂–µ—Ç–∞ –°–î–≠–ö:', error);
                updateStatus('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–∂–µ—Ç–∞');
            }
        });
    });

    function updateStatus(message) {
        const statusElement = document.getElementById('selection-status');
        if (statusElement) {
            statusElement.innerHTML = message;
            if (message.includes('‚ùå')) {
                statusElement.className = 'text-danger small fw-bold';
            } else if (message.includes('‚úÖ')) {
                statusElement.className = 'text-success small fw-bold';
            } else {
                statusElement.className = 'text-info small fw-bold';
            }
        }
    }

    function showSuccessNotification() {
        const alertElement = document.getElementById('success-alert');
        if (alertElement) {
            alertElement.style.display = 'block';
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
            setTimeout(() => {
                alertElement.style.display = 'none';
            }, 5000);
        }
    }

    // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–± –æ—Ç–∫—Ä—ã—Ç–∏—è –≤–∏–¥–∂–µ—Ç–∞ (–¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏)
    function openCdekWidget() {
        if (window.widget && typeof window.widget.open === 'function') {
            window.widget.open();
        } else {
            alert('–í–∏–¥–∂–µ—Ç –µ—â–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è. –ü–æ–¥–æ–∂–¥–∏—Ç–µ –Ω–µ–º–Ω–æ–≥–æ.');
        }
    }
</script>

<style>
.card {
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    border: none;
}

.card-header {
    border-bottom: 2px solid rgba(255,255,255,0.2);
}

.btn-lg {
    font-weight: 600;
}

@media (max-width: 768px) {
    .container-fluid {
        padding: 0 15px;
    }
    
    .btn-lg {
        padding: 0.75rem 1.5rem;
        font-size: 1.1rem;
    }
}
</style>
{% endblock %}