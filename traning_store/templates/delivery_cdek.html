{% extends "base.html" %}
{% load django_bootstrap5 %}
{% load static %}

{% block title %}–î–æ—Å—Ç–∞–≤–∫–∞ –°–î–≠–ö{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1 class="mb-4">üì¶ –î–æ—Å—Ç–∞–≤–∫–∞ –°–î–≠–ö</h1>
    
    <div class="row">
        <div class="col-12 col-lg-8">
            <!-- –í–∏–¥–∂–µ—Ç –°–î–≠–ö -->
            <div class="card mb-4">
                <div class="card-header bg-warning text-dark">
                    <h5 class="card-title mb-0">üìç –í—ã–±–µ—Ä–∏—Ç–µ –ø—É–Ω–∫—Ç –≤—ã–¥–∞—á–∏ –°–î–≠–ö</h5>
                </div>
                <div class="card-body">
                    <p class="mb-3">–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç—É —Å –ø—É–Ω–∫—Ç–∞–º–∏ –≤—ã–¥–∞—á–∏ –∑–∞–∫–∞–∑–æ–≤ –°–î–≠–ö</p>
                    
                    <!-- –ò–∑–º–µ–Ω–µ–Ω–Ω–∞—è –∫–Ω–æ–ø–∫–∞ -->
                    <button id="open-cdek-widget" class="btn btn-warning btn-lg w-100 py-3">
                        üó∫Ô∏è –û—Ç–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç—É –ü–í–ó –°–î–≠–ö
                    </button>
                    
                    <div id="cdek-map" class="mt-3" style="min-height: 500px;"></div>
                </div>
            </div>
        </div>
        
        <div class="col-12 col-lg-4">
            <!-- –§–æ—Ä–º–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è -->
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="card-title mb-0">‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤—ã–±–æ—Ä–∞</h5>
                </div>
                <div class="card-body">
                    <form action="" method="post" class="order-form">
                        {% csrf_token %}
                        <div class="mb-3">
                            {% bootstrap_form form %}
                        </div>
                        
                        <div class="alert alert-info small mb-3">
                            <strong>‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</strong> –ü–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –ø—É–Ω–∫—Ç–∞ –Ω–∞ –∫–∞—Ä—Ç–µ –¥–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è—Ç—Å—è –≤ —Ñ–æ—Ä–º–µ
                        </div>
                        
                        <button type="submit" class="btn btn-success w-100 py-3">
                            ‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ø—É–Ω–∫—Ç —Å–∞–º–æ–≤—ã–≤–æ–∑–∞
                        </button>
                    </form>
                </div>
            </div>
            
            <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤—ã–±–æ—Ä–µ -->
            <div class="card mt-3">
                <div class="card-header bg-primary text-white">
                    <h6 class="card-title mb-0">üìã –°—Ç–∞—Ç—É—Å –≤—ã–±–æ—Ä–∞</h6>
                </div>
                <div class="card-body">
                    <div id="selection-status" class="text-muted small">
                        –ü—É–Ω–∫—Ç –≤—ã–¥–∞—á–∏ –µ—â–µ –Ω–µ –≤—ã–±—Ä–∞–Ω
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–æ–≤ –°–î–≠–ö -->
<script src="https://cdn.jsdelivr.net/npm/@cdek-it/widget@3" type="text/javascript"></script>
<script src="https://cdn.jsdelivr.net/npm/@unocss/runtime" type="text/javascript"></script>
<link href="https://cdn.jsdelivr.net/npm/@unocss/reset/tailwind.min.css" rel="stylesheet">

<script type="text/javascript">
    let widget;

    document.addEventListener('DOMContentLoaded', () => {
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤–∏–¥–∂–µ—Ç–∞
        initializeWidget();
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –æ—Ç–∫—Ä—ã—Ç–∏—è –≤–∏–¥–∂–µ—Ç–∞
        document.getElementById('open-cdek-widget').addEventListener('click', function() {
            openWidget();
        });
    });

    function initializeWidget() {
        try {
            widget = new window.CDEKWidget({
                from: '–•–∏–º–∫–∏',
                root: 'cdek-map',
                apiKey: '08505f2e-943d-4ed9-8195-1b5a2739c6a3',
                canChoose: true,
                servicePath: 'https://kompressionnye-chulki24.ru/service.php',
                hideFilters: {
                    have_cashless: false,
                    have_cash: false,
                    is_dressing_room: false,
                    type: false,
                },
                hideDeliveryOptions: {
                    office: false,
                    door: true,
                },
                popup: false, // –ò–∑–º–µ–Ω–∏–ª–∏ –Ω–∞ false –¥–ª—è –≤—Å—Ç—Ä–∞–∏–≤–∞–Ω–∏—è –≤ —Å—Ç—Ä–∞–Ω–∏—Ü—É
                debug: true,
                goods: [
                    {
                        width: 10,
                        height: 10,
                        length: 10,
                        weight: 10,
                    },
                ],
                defaultLocation: [37.4297, 55.897],
                lang: 'rus',
                currency: 'RUB',
                tariffs: {
                    office: [234, 136],
                    door: [234, 136, 138],
                },
                onReady() {
                    console.log('‚úÖ –í–∏–¥–∂–µ—Ç –°–î–≠–ö –∑–∞–≥—Ä—É–∂–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ');
                    updateStatus('–í–∏–¥–∂–µ—Ç –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ');
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞—Ä—Ç—É —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
                    document.getElementById('cdek-map').style.display = 'block';
                },
                onCalculate() {
                    console.log('üí∞ –†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –¥–æ—Å—Ç–∞–≤–∫–∏ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω');
                },
                onChoose(type, tariff, address) {
                    console.log('üìç –í—ã–±—Ä–∞–Ω –º–µ—Ç–æ–¥ –¥–æ—Å—Ç–∞–≤–∫–∏', type, tariff, address);
                    
                    let message = '';
                    if (type === 'door') {
                        message = '–í—ã–±—Ä–∞–Ω–∞ –¥–æ—Å—Ç–∞–≤–∫–∞ –∫—É—Ä—å–µ—Ä–æ–º –ø–æ –∞–¥—Ä–µ—Å—É: ' + address.formatted +
                                '\n–¶–µ–Ω–∞: ' + tariff.delivery_sum + ' —Ä—É–±.' +
                                '\n–°—Ä–æ–∫: ' + tariff.period_max + ' –¥–Ω.';
                    } else {
                        message = '–í—ã–±—Ä–∞–Ω –ø—É–Ω–∫—Ç –≤—ã–¥–∞—á–∏ –∑–∞–∫–∞–∑–∞: ' + address.name +
                                '\n–¶–µ–Ω–∞: ' + tariff.delivery_sum + ' —Ä—É–±.' +
                                '\n–°—Ä–æ–∫: ' + tariff.period_max + ' –¥–Ω.';
                    }
                    
                    // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É
                    if (document.getElementById('id_sum')) {
                        document.getElementById('id_sum').value = tariff.delivery_sum;
                    }
                    if (document.getElementById('id_address_pvz')) {
                        document.getElementById('id_address_pvz').value = address.name;
                    }
                    
                    showSuccessMessage(message);
                    updateStatus('‚úÖ –ü—É–Ω–∫—Ç –≤—ã–±—Ä–∞–Ω: ' + address.name);
                },
                onError(error) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –≤–∏–¥–∂–µ—Ç–∞ –°–î–≠–ö:', error);
                    updateStatus('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–∂–µ—Ç–∞');
                }
            });
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –≤–∏–¥–∂–µ—Ç–∞:', error);
            updateStatus('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –≤–∏–¥–∂–µ—Ç–∞');
        }
    }

    function openWidget() {
        try {
            if (widget && typeof widget.open === 'function') {
                widget.open();
            } else {
                // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–± - –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ –∫–∞—Ä—Ç–µ
                document.getElementById('cdek-map').scrollIntoView({ 
                    behavior: 'smooth' 
                });
                updateStatus('–ö–∞—Ä—Ç–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –í—ã–±–µ—Ä–∏—Ç–µ –ø—É–Ω–∫—Ç –≤—ã–¥–∞—á–∏ –Ω–∞ –∫–∞—Ä—Ç–µ –Ω–∏–∂–µ.');
            }
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è –≤–∏–¥–∂–µ—Ç–∞:', error);
            updateStatus('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –≤–∏–¥–∂–µ—Ç');
        }
    }

    function updateStatus(message) {
        const statusElement = document.getElementById('selection-status');
        if (statusElement) {
            statusElement.innerHTML = message;
            if (message.includes('‚ùå')) {
                statusElement.className = 'text-danger small fw-bold';
            } else if (message.includes('‚úÖ')) {
                statusElement.className = 'text-success small fw-bold';
            } else {
                statusElement.className = 'text-info small fw-bold';
            }
        }
    }

    function showSuccessMessage(message) {
        // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        const existingAlerts = document.querySelectorAll('.alert-success');
        existingAlerts.forEach(alert => alert.remove());
        
        // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        const notification = document.createElement('div');
        notification.className = 'alert alert-success alert-dismissible fade show mt-3';
        notification.innerHTML = `
            <strong>‚úÖ –í—ã–±–æ—Ä —Å–æ—Ö—Ä–∞–Ω–µ–Ω!</strong><br>
            ${message.replace(/\n/g, '<br>')}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        // –î–æ–±–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ —Ñ–æ—Ä–º–æ–π
        const form = document.querySelector('.order-form');
        if (form && form.parentNode) {
            form.parentNode.insertBefore(notification, form);
        }
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ 7 —Å–µ–∫—É–Ω–¥
        setTimeout(() => {
            if (notification.parentNode) {
                const bsAlert = new bootstrap.Alert(notification);
                bsAlert.close();
            }
        }, 7000);
    }
</script>

<style>
.card {
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    border: none;
}

.card-header {
    border-bottom: 2px solid rgba(255,255,255,0.2);
}

#cdek-map {
    min-height: 500px;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    background-color: #f8f9fa;
    display: block; /* –ò–∑–º–µ–Ω–∏–ª–∏ –Ω–∞ block */
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ */
.loading-spinner {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid #f3f3f3;
    border-top: 3px solid #3498db;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-right: 10px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

@media (max-width: 768px) {
    .container-fluid {
        padding: 0 15px;
    }
    
    .btn-lg {
        padding: 0.75rem 1.5rem;
        font-size: 1.1rem;
    }
    
    #cdek-map {
        min-height: 400px;
    }
}
</style>
{% endblock %}