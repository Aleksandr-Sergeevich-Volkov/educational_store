{% extends "base.html" %}
{% load static %}
{% load django_bootstrap5 %}

<head>
    <title>–ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –º–∞–≥–∞–∑–∏–Ω–∞ –∫–æ–º–ø—Ä–µ—Å—Å–∏–æ–Ω–Ω–æ–≥–æ —Ç—Ä–∏–∫–æ—Ç–∞–∂–∞</title>
</head>

{% block content %}
<!-- –ü–æ–∏—Å–∫–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞ - —Ç–∞–∫–æ–π –∂–µ —à–∏—Ä–∏–Ω—ã –∫–∞–∫ –∑–∞–≥–æ–ª–æ–≤–æ–∫ -->
<div class="mb-3">
    <div class="card-header font-family:sans-serif">
        <form method="get" action="{% url 'homepage:search' %}" class="mb-0">
            <div class="input-group">
                <input type="text" 
                       name="query" 
                       class="form-control" 
                       placeholder="–ë—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é, –∞—Ä—Ç–∏–∫—É–ª—É –∏–ª–∏ –±—Ä–µ–Ω–¥—É..."
                       id="home-search-input"
                       autocomplete="off"
                       aria-label="–ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–æ–≤"
                       style="border-top-right-radius: 0; border-bottom-right-radius: 0;">
                <button type="submit" class="btn btn-primary" 
                        style="border-top-left-radius: 0; border-bottom-left-radius: 0;">
                    <i class="bi bi-search"></i> –ù–∞–π—Ç–∏
                </button>
            </div>
        </form>
        <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è -->
        <div id="home-autocomplete" class="autocomplete-dropdown mt-1"></div>
    </div>
</div>

<div class="mb-3 d-flex justify-content-between align-items-center">
    <div class="d-flex flex-wrap gap-2 align-items-center flex-grow-1">
        {% for brand in popular_brands %}
        <a href="{% url 'homepage:search' %}?query={{ brand.name }}"
           class="btn btn-primary d-flex align-items-center justify-content-center"
           style="min-width: fit-content; padding: 0.5rem 1rem; margin: 2px;">
            {% if brand.logo %}
            <img src="{{ brand.logo.url }}" 
                 alt="{{ brand.name }}"
                 class="me-2"
                 style="height: 22px; width: auto; max-width: 60px;">
            {% endif %}
            <span style="font-size: 0.95rem;">{{ brand.name }}</span>
        </a>
        {% endfor %}
    </div>
    
    <div class="ms-3 flex-shrink-0">
        <a title="Telegram" href="https://telegram.me/volkovaleksandrsergeevich" 
           target="_blank" class="telegram-btn">
            <img src="{% static 'telegram_icon.jpg' %}" 
                 class="img-fluid" 
                 style="max-width: 65px;" 
                 alt='–ù–∞–ø–∏—Å–∞—Ç—å –≤ Telegram'>
        </a>
    </div>
</div>

<style>
.telegram-btn {
    display: inline-block;
    transition: all 0.3s ease;
}

.pulse-animation {
    animation: pulse 2s infinite;
    transition: transform 0.3s ease;
}

.pulse-animation:hover {
    animation: none;
    transform: scale(1.1);
}

@keyframes pulse {
    0% {
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(0, 136, 204, 0.7);
    }
    70% {
        transform: scale(1.05);
        box-shadow: 0 0 0 10px rgba(0, 136, 204, 0);
    }
    100% {
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(0, 136, 204, 0);
    }
}
</style>

<!-- –ö–Ω–æ–ø–∫–∏ - –æ–¥–∏–Ω–∞–∫–æ–≤–æ–π —à–∏—Ä–∏–Ω—ã –∏ –≤—ã—Ä–æ–≤–Ω–µ–Ω—ã -->
<div class="row mb-4">
    <div class="col-md-4 mb-2 mb-md-0">
        <a href="catalog/" class="btn btn-primary w-100">–ö–∞—Ç–∞–ª–æ–≥ –≤—Å–µ—Ö —Ç–æ–≤–∞—Ä–æ–≤</a>
    </div>
<div class="col-md-4 mb-2 mb-md-0">
    <div class="d-flex gap-1">
        <a href="{% url 'homepage:search' %}?query=—á—É–ª–∫–∏" 
           class="btn btn-primary flex-fill">
            üë¢ –ß—É–ª–∫–∏
        </a>
        <a href="{% url 'homepage:search' %}?query=–≥–æ–ª—å—Ñ—ã" 
           class="btn btn-primary flex-fill">
            üß¶ –ì–æ–ª—å—Ñ—ã
        </a>
        <a href="{% url 'homepage:search' %}?query=–∫–æ–ª–≥–æ—Ç–∫–∏" 
           class="btn btn-primary flex-fill">
            üëñ –ö–æ–ª–≥–æ—Ç–∫–∏
        </a>
    </div>
</div>
    <div class="col-md-4">
        <a href="size_finder/" class="btn btn-primary w-100">–ü–æ–¥–±–æ—Ä —Ä–∞–∑–º–µ—Ä–∞</a>
    </div>
</div>

<!-- –¢—Ä–∏ –∫–æ–ª–æ–Ω–∫–∏ –ø–æ–¥ –∫–Ω–æ–ø–∫–∞–º–∏ - –æ–¥–∏–Ω–∞–∫–æ–≤–æ–π —à–∏—Ä–∏–Ω—ã -->
<div class="row mb-4">
    <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –ª–æ–≥–æ—Ç–∏–ø (–ø–æ–¥ –∫–Ω–æ–ø–∫–æ–π "–ö–∞—Ç–∞–ª–æ–≥") -->
    <div class="col-md-4 mb-3 mb-md-0">
        <div class="text-center">
            <div class="mb-3" style="max-width: 100%;">
                <img src="{% static 'logo.jpeg' %}" 
                     alt="–õ–æ–≥–æ—Ç–∏–ø –º–∞–≥–∞–∑–∏–Ω–∞" 
                     class="img-fluid"
                     style="max-width: 100%; height: auto;">
            </div>
            <div>
                <a href="catalog/">–í—Å–µ–≥–æ —Ç–æ–≤–∞—Ä–æ–≤ –≤ –Ω–∞—à–µ–º –º–∞–≥–∞–∑–∏–Ω–µ: {{prod_count.id__count}}</a>
            </div>
        </div>
    </div>
    
    <!-- –°—Ä–µ–¥–Ω—è—è –∫–æ–ª–æ–Ω–∫–∞: –ø–æ–ø—É–ª—è—Ä–Ω–æ–µ (–ø–æ–¥ –∫–Ω–æ–ø–∫–æ–π "–ü–æ–∏—Å–∫") - –≤—ã—Ä–æ–≤–Ω–µ–Ω–æ –ø–æ –ª–µ–≤–æ–º—É –∫—Ä–∞—é -->
<div class="col-md-4 mb-3 mb-md-0">
    <div class="text-center">
        <h6 class="mb-3 text-primary">
            <i class="bi bi-star-fill me-1"></i>–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã
        </h6>
        <div class="d-flex flex-column gap-3">
            {% for prod in popular_products %}
            <a href="{% url 'catalog:detail' prod.slug %}" 
               class="text-decoration-none d-flex align-items-center hover-card p-2 rounded">
                <div class="flex-shrink-0 me-3" style="width: 80px; height: 80px;">
                    <img src="{{ prod.main_images.0.image.url }}" 
                         alt="{{ prod.name }}" 
                         class="img-fluid rounded"
                         style="width: 100%; height: 100%; object-fit: contain; background: #f8f9fa;">
                </div>
                <div class="flex-grow-1 text-start">
                    <div class="fw-medium text-dark mb-1" style="font-size: 0.9rem; line-height: 1.2;">
                        {{ prod.name|truncatechars:40 }}
                    </div>                    
                    <!-- –î–æ–±–∞–≤–ª–µ–Ω –∞—Ä—Ç–∏–∫—É–ª -->
                    {% if prod.articul and prod.brand%}
                    <div class="text-muted small mb-1">
                        <i class="bi bi-upc-scan me-1"></i>{{ prod.brand.name }} –ê—Ä—Ç: {{ prod.articul }}
                    </div>
                    {% endif %} 
                    <div class="text-success fw-bold">{{ prod.price }} ‚ÇΩ</div>
                </div>
            </a>
            {% endfor %}
        </div>
    </div>
</div>

<style>
.hover-card:hover {
    background-color: #f8f9fa;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    transition: all 0.2s ease;
}
</style>
    
    <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –ø–æ—Å—Ç—ã (–ø–æ–¥ –∫–Ω–æ–ø–∫–æ–π "–ü–æ–¥–±–æ—Ä") -->
    <div class="col-md-4">
        {% for post in text %} 
        <div class="mb-3">
            <p class="h5 mb-2">{{ post.title }}</p>          
            
            <div class="post-content">
                <p class="card-text mb-2" id="text-{{ post.id }}">
                    {{ post.text|truncatewords:25 }}
                </p>
            </div>
            
            <!-- –ö–Ω–æ–ø–∫–∏ –≤ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É -->
            <div class="d-flex gap-1">
                <button class="btn btn-outline-primary btn-sm flex-fill" 
                        onclick="toggleFullText({{ post.id }}, '{{ post.text|escapejs }}')"
                        style="white-space: nowrap;">
                    üìñ –ß–∏—Ç–∞—Ç—å –ø–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç
                </button>
                
                <button class="btn btn-outline-secondary btn-sm flex-fill" 
                        data-post-id="{{ post.id }}"
                        data-comment-count="{{ post.comment_count }}"
                        onclick="toggleComments({{ post.id }})"
                        style="white-space: nowrap;">
                    üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ ({{ post.comment_count }})
                </button>
            </div>
            
            <!-- –ë–ª–æ–∫ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ (–∏–∑–Ω–∞—á–∞–ª—å–Ω–æ —Å–∫—Ä—ã—Ç) -->
            <div id="comments-{{ post.id }}" class="comments-section mt-3" style="display: {% if request.GET.open_comments == post.id|stringformat:'i' %}block{% else %}none{% endif %};">
                <div class="card">
                    <div class="card-header bg-light d-flex justify-content-between align-items-center">
                        <h6 class="card-title mb-0">üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ ({{ post.comment_count }})</h6>
                        <button class="btn btn-close btn-sm" onclick="toggleComments({{ post.id }})"></button>
                    </div>
                    <div class="card-body">
                        {% if post.comments.all %}
                            {% for comment in post.comments.all %}
                            <div class="comment mb-3 pb-3 border-bottom">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <div>
                                        <strong class="text-primary">{{ comment.author.username }}</strong>
                                        <small class="text-muted ms-2">{{ comment.created_at|date:"d.m.Y H:i" }}</small>
                                        {% if comment.updated_at != comment.created_at %}
                                        <small class="text-muted ms-2">(–∏–∑–º–µ–Ω–µ–Ω–æ)</small>
                                        {% endif %}
                                    </div>
                                    
                                    <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–ª—è –∞–≤—Ç–æ—Ä–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è -->
                                    {% if user == comment.author %}
                                    <div class="btn-group btn-group-sm">
                                        <a href="{% url 'homepage:edit_comment' post.id comment.id %}" 
                                           class="btn btn-outline-warning btn-sm"
                                           title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π">
                                            ‚úèÔ∏è
                                        </a>
                                        <a href="{% url 'homepage:delete_comment' post.id comment.id %}" 
                                           class="btn btn-outline-danger btn-sm"
                                           title="–£–¥–∞–ª–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"
                                           onclick="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π?');">
                                            üóëÔ∏è
                                        </a>
                                    </div>
                                    {% endif %}
                                </div>
                                
                                <!-- –¢–µ–∫—Å—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è -->
                                <p class="mb-0 comment-text">
                                    {{ comment.text }}
                                </p>
                            </div>
                            {% endfor %}
                        {% else %}
                            <p class="text-muted mb-0">–ü–æ–∫–∞ –Ω–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º!</p>
                        {% endif %}
                        
                        <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è -->
                        {% if user.is_authenticated %}
                        <div class="add-comment mt-3 pt-3 border-top">
                            <form method="post" action="{% url 'homepage:add_comment' post.id %}" class="comment-form">
                                {% csrf_token %}
                                <div class="mb-2">
                                    <textarea name="text" class="form-control form-control-sm" 
                                              rows="2" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..." required></textarea>
                                </div>
                                <button type="submit" class="btn btn-primary btn-sm">üí¨ –î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</button>
                            </form>
                        </div>
                        {% else %}
                        <div class="mt-3 pt-3 border-top">
                            <a href="{% url 'login' %}?next={{ request.path }}" class="btn btn-outline-primary btn-sm">
                                üîë –í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å
                            </a>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
<div class="row mt-4">
    <!-- –ö–æ–Ω—Ç–∞–∫—Ç—ã -->
<div class="col-12 col-md-4 mb-3 mb-md-0 d-flex align-items-center">
    <div class="card contact-card p-3 w-100">
        <div class="card-body p-0">
            <h6 class="card-title text-primary mb-3">
                <i class="fas fa-address-book me-2"></i>–ö–æ–Ω—Ç–∞–∫—Ç—ã
            </h6>
            <div class="contact-info" style="font-size: 13px; font-family: 'Segoe UI', sans-serif;">
                <div class="mb-2">
                    <strong>–û–û–û "–ö–æ–Ω—Å–∞–ª—Ç–∏–Ω–≥–æ–≤—ã–π –¶–µ–Ω—Ç—Ä "–ê–ª–≥–æ—Ä–∏—Ç–º"</strong>
                </div>
                <div class="text-muted small mb-2">
                    <i class="fas fa-file-invoice me-1"></i>
                    –†/—Å 40702810200010000418 –≤ –ê–ö–ë "–ê–ë–°–û–õ–Æ–¢ –ë–ê–ù–ö" (–ü–ê–û)<br>
                    –ö/—Å 30101810500000000976, –ë–ò–ö 044525976
                </div>
                <div class="mb-2">
                    <i class="fas fa-map-marker-alt me-1 text-danger"></i>
                    141402, –ú–æ—Å–∫–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å, –≥. –•–∏–º–∫–∏, –°–æ—é–∑–Ω–∞—è —É–ª., –¥. 3, –æ—Ñ–∏—Å 15
                </div>
                <div class="mb-2">
                    <i class="fas fa-phone me-1 text-success"></i>
                    8-906-717-48-77
                    <span class="ms-2">
                        <i class="fab fa-telegram text-info"></i>
                        <i class="fab fa-whatsapp text-success ms-1"></i>
                    </span>
                </div>
                <!-- –†–ê–ë–û–¢–ê–ï–¢ –ò –ù–ê –ö–û–ú–ü–¨–Æ–¢–ï–†–ï, –ò –ù–ê –¢–ï–õ–ï–§–û–ù–ï -->
                <div>
    <i class="fas fa-envelope me-1 text-warning"></i>
    <!-- –û—Å–Ω–æ–≤–Ω–∞—è —Å—Å—ã–ª–∫–∞ –¥–ª—è –ø–æ—á—Ç–æ–≤—ã—Ö –ø—Ä–æ–≥—Ä–∞–º–º (Outlook –∏ –¥—Ä.) -->
    <a href="mailto:volkov_aleksandr_sergeevich@mail.ru" 
       style="text-decoration: none; color: inherit;">
        volkov_aleksandr_sergeevich@mail.ru
    </a>
    <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–∫–æ–Ω–∫–∞ –¥–ª—è –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ (–∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç) -->
    <a href="https://e.mail.ru/compose/?mailto=volkov_aleksandr_sergeevich@mail.ru" 
       target="_blank" 
       class="ms-2 text-decoration-none"
       title="–ù–∞–ø–∏—Å–∞—Ç—å —á–µ—Ä–µ–∑ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å Mail.ru">
        <i class="fas fa-external-link-alt fa-xs"></i>
    </a>
</div>
            </div>
        </div>
    </div>
</div>
    
    <!-- –ü—É—Å—Ç–∞—è –∫–æ–ª–æ–Ω–∫–∞ –¥–ª—è –æ—Ç—Å—Ç—É–ø–∞ -->
    <div class="col-md-4 d-none d-md-block"></div>
    
    <!-- –ö–Ω–æ–ø–∫–∞ –æ—Ñ–µ—Ä—Ç—ã -->
    <div class="col-12 col-md-4 d-flex align-items-center">
        <a href="{% static 'oferta.pdf' %}" class="btn btn-primary btn-oferta w-100 py-3">
            <i class="fas fa-file-contract me-2"></i>
            <span class="fw-bold">–î–æ–≥–æ–≤–æ—Ä –æ—Ñ–µ—Ä—Ç—ã</span>
        </a>
    </div>
</div>

<style>
.contact-card {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border: 1px solid #e0e0e0;
    border-radius: 12px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.contact-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(0,0,0,0.1);
}

.contact-info div {
    margin-bottom: 8px;
    line-height: 1.5;
}

.btn-oferta {
    background: linear-gradient(135deg, #0d6efd 0%, #0b5ed7 100%);
    border: none;
    border-radius: 10px;
    font-size: 16px;
    padding: 12px 24px;
    transition: all 0.3s ease;
    box-shadow: 0 4px 6px rgba(13, 110, 253, 0.2);
}

.btn-oferta:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(13, 110, 253, 0.3);
    background: linear-gradient(135deg, #0b5ed7 0%, #0a58ca 100%);
}

/* –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏ */
.d-flex.align-items-center {
    display: flex;
    align-items: center;
}

/* –ù–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö –¥–µ–ª–∞–µ–º –æ–±—ã—á–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ */
@media (max-width: 768px) {
    .d-flex.align-items-center {
        display: block !important;
    }
    
    .btn-oferta {
        margin-top: 1rem;
    }
}
</style>
</div>
{% endblock %}
{% block extra_js %}
<script>
// –ê–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–ª—è –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('home-search-input');
    const autocompleteContainer = document.getElementById('home-autocomplete');
    
    if (!searchInput || !autocompleteContainer) return;
    
    let currentRequest = null;
    
    searchInput.addEventListener('input', function() {
        const query = this.value.trim();
        
        // –û—Ç–º–µ–Ω—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∑–∞–ø—Ä–æ—Å
        if (currentRequest) {
            currentRequest.abort();
        }
        
        // –û—á–∏—â–∞–µ–º –∏ —Å–∫—Ä—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
        autocompleteContainer.innerHTML = '';
        autocompleteContainer.style.display = 'none';
        
        if (query.length >= 2) {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            autocompleteContainer.innerHTML = `
                <div class="autocomplete-loading p-2 text-center text-muted">
                    <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                    –ü–æ–∏—Å–∫...
                </div>
            `;
            autocompleteContainer.style.display = 'block';
            
            // –î–µ–ª–∞–µ–º AJAX –∑–∞–ø—Ä–æ—Å
            currentRequest = new XMLHttpRequest();
            currentRequest.open('GET', '{% url "homepage:autocomplete" %}?term=' + encodeURIComponent(query));
            currentRequest.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
            
            currentRequest.onload = function() {
                if (currentRequest.status === 200) {
                    const data = JSON.parse(currentRequest.responseText);
                    autocompleteContainer.innerHTML = '';
                    
                    if (data.suggestions && data.suggestions.length > 0) {
                       data.suggestions.forEach(item => {
    const link = document.createElement('a');
    link.href = item.url || '#';
    link.className = 'autocomplete-item d-block p-2 border-bottom';
    link.style.textDecoration = 'none';
    
    let html = `
        <div class="d-flex align-items-center">
            ${item.image ? `
                <div class="flex-shrink-0 me-2" style="width: 40px; height: 40px;">
                    <img src="${item.image}" 
                         alt="${item.name}" 
                         class="img-fluid rounded"
                         style="width: 100%; height: 100%; object-fit: cover;">
                </div>
            ` : `
                <div class="flex-shrink-0 me-2" style="width: 40px; height: 40px;">
                    <div class="bg-light rounded d-flex align-items-center justify-content-center" 
                         style="width: 100%; height: 100%;">
                        <i class="bi bi-image text-muted"></i>
                    </div>
                </div>
            `}
            
            <div class="flex-grow-1">
                <strong class="d-block">${item.name || ''}</strong>
                <small class="text-muted d-block">
                    ${item.brand ? `${item.brand} ‚Ä¢ ` : ''}${item.articul}
                </small>
            </div>
            
            <div class="flex-shrink-0 text-end ms-2">
                <span class="text-success fw-bold">${item.price || ''}</span>
            </div>
        </div>
    `;
    
    link.innerHTML = html;
    autocompleteContainer.appendChild(link);
});
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º —Å—Å—ã–ª–∫—É "–í—Å–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã"
                        const allResults = document.createElement('a');
                        allResults.href = '{% url "homepage:search" %}?query=' + encodeURIComponent(query);
                        allResults.className = 'autocomplete-all-results d-block p-2 text-center bg-light';
                        allResults.style.textDecoration = 'none';
                        allResults.innerHTML = `
                            <small><strong>–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</strong></small>
                        `;
                        autocompleteContainer.appendChild(allResults);
                        
                        autocompleteContainer.style.display = 'block';
                    } else {
                        autocompleteContainer.innerHTML = `
                            <div class="autocomplete-no-results p-2 text-center text-muted">
                                <small><i class="bi bi-search me-1"></i>–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</small>
                            </div>
                        `;
                        autocompleteContainer.style.display = 'block';
                    }
                }
            };
            
            currentRequest.onerror = function() {
                autocompleteContainer.innerHTML = `
                    <div class="autocomplete-error p-2 text-center text-danger">
                        <small><i class="bi bi-exclamation-triangle me-1"></i>–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è</small>
                    </div>
                `;
            };
            
            currentRequest.send();
        }
    });
    
    // –°–∫—Ä—ã–≤–∞–µ–º –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ
    document.addEventListener('click', function(e) {
        if (!autocompleteContainer.contains(e.target) && e.target !== searchInput) {
            autocompleteContainer.style.display = 'none';
        }
    });
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∏ —Ñ–æ–∫—É—Å–µ (–µ—Å–ª–∏ –µ—Å—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã)
    searchInput.addEventListener('focus', function() {
        if (autocompleteContainer.children.length > 0) {
            autocompleteContainer.style.display = 'block';
        }
    });
    
    // –ü—Ä–∏ –ø–æ—Ç–µ—Ä–µ —Ñ–æ–∫—É—Å–∞ —Å–∫—Ä—ã–≤–∞–µ–º —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
    searchInput.addEventListener('blur', function() {
        setTimeout(() => {
            autocompleteContainer.style.display = 'none';
        }, 200);
    });
});

// –í–∞—à–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø–æ—Å—Ç–æ–≤ –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
function toggleFullText(postId, fullText) {
    const textElement = document.getElementById(`text-${postId}`);
    const button = event.target;
    
    if (button.textContent.includes('–ß–∏—Ç–∞—Ç—å –ø–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç')) {
        textElement.textContent = fullText;
        button.textContent = 'üìñ –°–∫—Ä—ã—Ç—å';
        button.classList.add('active');
    } else {
        const words = fullText.split(' ');
        const shortText = words.length > 25 ? words.slice(0, 25).join(' ') + '...' : fullText;
        textElement.textContent = shortText;
        button.textContent = 'üìñ –ß–∏—Ç–∞—Ç—å –ø–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç';
        button.classList.remove('active');
    }
}

function toggleComments(postId) {
    const commentsSection = document.getElementById(`comments-${postId}`);
    const button = document.querySelector(`[data-post-id="${postId}"]`);
    const commentCount = button.getAttribute('data-comment-count');
    
    if (commentsSection.style.display === 'none') {
        commentsSection.style.display = 'block';
        button.textContent = 'üí¨ –°–∫—Ä—ã—Ç—å';
        button.classList.add('active');
        
        commentsSection.style.opacity = '0';
        commentsSection.style.transition = 'opacity 0.3s ease';
        setTimeout(() => {
            commentsSection.style.opacity = '1';
        }, 10);
    } else {
        commentsSection.style.opacity = '0';
        setTimeout(() => {
            commentsSection.style.display = 'none';
            button.textContent = `üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ (${commentCount})`;
            button.classList.remove('active');
        }, 300);
    }
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
document.addEventListener('DOMContentLoaded', function() {
    const commentForms = document.querySelectorAll('.comment-form');
    commentForms.forEach(form => {
        form.addEventListener('submit', function(e) {
            const button = this.querySelector('button[type="submit"]');
            button.innerHTML = '‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞...';
            button.disabled = true;
        });
    });
    
    // –û—Ç–∫—Ä—ã—Ç–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –∏–∑ URL –ø–∞—Ä–∞–º–µ—Ç—Ä–∞
    const urlParams = new URLSearchParams(window.location.search);
    const postIdToOpen = urlParams.get('open_comments');
    
    if (postIdToOpen) {
        const commentsDiv = document.getElementById(`comments-${postIdToOpen}`);
        
        if (commentsDiv) {
            commentsDiv.style.display = 'block';
            
            const button = document.querySelector(`[onclick*="${postIdToOpen}"]`);
            if (button && button.textContent.includes('(')) {
                button.textContent = 'üí¨ –°–∫—Ä—ã—Ç—å';
            }
            
            setTimeout(() => {
                commentsDiv.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'start' 
                });
                
                const textarea = commentsDiv.querySelector('textarea[name="text"]');
                if (textarea) {
                    textarea.focus();
                }
            }, 100);
        }
    }
});
</script>

<style>
/* –°—Ç–∏–ª–∏ —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è */
.autocomplete-dropdown {
    position: absolute;
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    box-shadow: 0 0.25rem 0.5rem rgba(0, 0, 0, 0.1);
    max-height: 250px;
    overflow-y: auto;
    z-index: 1000;
    width: 100%;
    display: none;
}

.autocomplete-item {
    border-bottom: 1px solid #f8f9fa;
    color: #212529;
    transition: background-color 0.15s;
    font-size: 0.9rem;
}

.autocomplete-item:hover {
    background-color: #f8f9fa;
    text-decoration: none;
}

.autocomplete-all-results {
    color: #0d6efd;
    border-top: 1px solid #dee2e6;
    font-size: 0.85rem;
}

.autocomplete-all-results:hover {
    background-color: #e7f1ff;
}

.autocomplete-loading,
.autocomplete-no-results,
.autocomplete-error {
    font-size: 0.85rem;
}

/* –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ "–°–∞–º–æ–µ –ø–æ–ø—É–ª—è—Ä–Ω–æ–µ" –ø–æ –ª–µ–≤–æ–º—É –∫—Ä–∞—é */
.col-md-4:nth-child(2) > div {
    text-align: left;
}

/* –ö–Ω–æ–ø–∫–∏ –≤ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É –¥–ª—è –ø–æ—Å—Ç–æ–≤ */
.col-md-4:last-child .d-flex.gap-1 {
    display: flex;
    gap: 0.25rem;
}

.col-md-4:last-child .btn-sm {
    flex: 1;
    min-width: 0;
    padding: 0.25rem 0.5rem;
    font-size: 0.8rem;
    white-space: nowrap;
}

/* –û–¥–∏–Ω–∞–∫–æ–≤–∞—è —à–∏—Ä–∏–Ω–∞ –¥–ª—è –≤—Å–µ—Ö –∫–æ–ª–æ–Ω–æ–∫ */
.row .col-md-4 {
    display: flex;
    flex-direction: column;
}

/* –ö–Ω–æ–ø–∫–∏ –∑–∞–Ω–∏–º–∞—é—Ç –≤—Å—é —à–∏—Ä–∏–Ω—É –∫–æ–ª–æ–Ω–∫–∏ */
.row .col-md-4 .btn {
    width: 100%;
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
@media (max-width: 768px) {
    .row .col-md-4 {
        margin-bottom: 1.5rem;
    }
    
    .col-md-4:nth-child(2) > div {
        text-align: center;
    }
    
    .col-md-4:last-child .d-flex.gap-1 {
        justify-content: center;
    }
    
    .col-md-4:last-child .btn-sm {
        flex: 0 1 auto;
        min-width: 100px;
    }
}

/* –í–∞—à–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å—Ç–∏–ª–∏ –¥–ª—è –ø–æ—Å—Ç–æ–≤ –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ */
.comments-section {
    transition: all 0.3s ease;
}

.btn.active {
    background-color: #0d6efd;
    color: white;
    border-color: #0d6efd;
}

.comment:last-child {
    border-bottom: none !important;
    margin-bottom: 0 !important;
    padding-bottom: 0 !important;
}

.add-comment {
    background-color: #f8f9fa;
    border-radius: 0.375rem;
    padding: 1rem;
}

.comment-form textarea {
    resize: vertical;
    min-height: 80px;
}

.d-flex.gap-2 {
    gap: 0.5rem;
}

.card {
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    border: 1px solid #e9ecef;
}

.btn-group-sm .btn {
    padding: 0.125rem 0.25rem;
    font-size: 0.75rem;
    text-decoration: none;
}
</style>
{% endblock %}