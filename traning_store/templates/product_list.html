{% extends "base.html" %}
{% load catalog_tags %}
{% load django_bootstrap5 %}
{% load static %}

<head>
    <title>{% block title %}{{ seo_title }}{% endblock %}</title>
    <meta name="description" content="{{ seo_description }}">
</head>

{% block content %}
<div class="container-fluid">
    <!-- Заголовок и счетчик -->
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="h4 mb-3">{{ seo_h1 }}</h1>
            <div class="text-muted">Всего товаров: {{ prod_count.id__count }}</div>
        </div>
    </div>

    <!-- Форма фильтрации -->
     <div class="row mb-4">
        <div class="col-12">
            <form method="get" class="filter-form">
                <div class="row g-3 align-items-end">
                    <!-- Все поля фильтра -->
                    <div class="col-12 col-sm-6 col-md-4 col-lg-2">
                        <label for="{{ filter.form.Appointment.id_for_label }}" class="form-label">Назначение</label>
                        {{ filter.form.Appointment }}
                    </div>
                    
                    <div class="col-12 col-sm-6 col-md-4 col-lg-2">
                        <label for="{{ filter.form.Sock.id_for_label }}" class="form-label">Тип носка</label>
                        {{ filter.form.Sock }}
                    </div>
                    
                    <div class="col-12 col-sm-6 col-md-4 col-lg-2">
                        <label for="{{ filter.form.brand.id_for_label }}" class="form-label">Производитель</label>
                        {{ filter.form.brand }}
                    </div>
                    
                    <div class="col-12 col-sm-6 col-md-4 col-lg-2">
                        <label for="{{ filter.form.Class_compress.id_for_label }}" class="form-label">Класс компрессии</label>
                        {{ filter.form.Class_compress }}
                    </div>
                    
                    <div class="col-12 col-sm-6 col-md-4 col-lg-2">
                        <label for="{{ filter.form.Type_product.id_for_label }}" class="form-label">Вид изделия</label>
                        {{ filter.form.Type_product }}
                    </div>
                    
                    <div class="col-12 col-sm-6 col-md-4 col-lg-2">
                        <label for="{{ filter.form.Male.id_for_label }}" class="form-label">Пол</label>
                        {{ filter.form.Male }}
                    </div>
                    
                    <!-- Кнопки фильтра -->
                    <div class="col-12 mt-2">
                        <button type="submit" class="btn btn-primary">Применить фильтр</button>
                        <a href="?" class="btn btn-outline-secondary ms-2">Сбросить</a>
                    </div>
                </div>
            </form>
        </div>
    </div>
    <!-- ... ваш существующий код фильтров ... -->

    <!-- Список товаров с ПОЛНОЙ микроразметкой -->
    <div class="row" itemscope itemtype="https://schema.org/ItemList">
        <meta itemprop="name" content="{{ seo_title|default:'Каталог компрессионного трикотажа' }}">
        <meta itemprop="description" content="{{ seo_description|default:'Широкий выбор компрессионного трикотажа' }}">
        <meta itemprop="numberOfItems" content="{{ prod_count.id__count }}">
        
        {% for product in page_obj.object_list %}
        <div class="col-12 col-sm-6 col-lg-4 col-xl-3 mb-4" 
             itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
            <meta itemprop="position" content="{{ forloop.counter }}">
            
            <div class="card h-100" itemscope itemtype="https://schema.org/Product">
                <!-- Изображение товара -->
                <div class="text-center p-3">
                    {% for image in product.main_images %}
                    <a href="{% url 'catalog:detail' product.slug %}">
                        <img src="{{ image.image.url }}" 
                             alt="{{ product.seo_alt|default:product.name }}" 
                             class="card-img-top img-fluid" 
                             style="max-height: 200px; width: auto; object-fit: contain;"
                             itemprop="image">
                    </a>
                    {% empty %}
                    <div class="bg-light d-flex align-items-center justify-content-center" 
                         style="height: 200px;">
                        <span class="text-muted">Нет изображения</span>
                    </div>
                    {% endfor %}
                </div>

                <!-- Информация о товаре -->
                <div class="card-body d-flex flex-column">
    <h2 class="h5 card-title">
    <a href="{% url 'catalog:detail' product.slug %}" class="text-decoration-none" itemprop="url">
        {{ product.seo_title|default:product.name }}
    </a>
</h2>
                    
                    <!-- Артикул товара -->
                    {% if product.articul %}
                    <div class="mb-2">
                        <small class="text-muted">Артикул:</small>
                        <span class="fw-bold" itemprop="sku">{{ product.articul }}</span>
                        <meta itemprop="productID" content="{{ product.articul }}">
                    </div>
                    {% endif %}
                    
                    <div class="mb-2">
                        <small class="text-muted">Производитель:</small>
                        <span class="fw-bold" itemprop="brand" itemscope itemtype="https://schema.org/Brand">
                            <span itemprop="name">{{ product.brand.name }}</span>
                        </span>
                    </div>
                    
                    <div class="mb-2">
                        <small class="text-muted">Категория:</small>
                        <span itemprop="category">{{ product.Type_product }}</span>
                    </div>
                     <div style="display: none;" itemprop="description">
            {{ product.seo_description|default:product.name }} - компрессионный трикотаж {{ product.brand.name }}. {{ product.Type_product }} {{ product.article }}.
        </div>

                    <!-- Цена -->
                    <div class="mt-auto" itemprop="offers" itemscope itemtype="https://schema.org/Offer">
    <div class="d-flex justify-content-between align-items-center">
        <span class="h5 text-primary mb-0">
            {{ product.price }} ₽
            <meta itemprop="price" content="{{ product.price|floatformat:'2u' }}">
            <meta itemprop="priceCurrency" content="RUB">
        </span>
        <meta itemprop="availability" content="https://schema.org/InStock">
        <link itemprop="url" href="{{ request.scheme }}://{{ request.get_host }}{% url 'catalog:detail' product.slug %}">
        
        <!-- ДОБАВЛЯЕМ ПОЛИТИКУ ВОЗВРАТА -->
        <div itemprop="hasMerchantReturnPolicy" itemscope itemtype="https://schema.org/MerchantReturnPolicy">
            <meta itemprop="returnPolicyCategory" content="https://schema.org/MerchantReturnFiniteReturnWindow">
            <meta itemprop="merchantReturnDays" content="14">
        </div>
        
        <!-- ДОБАВЛЯЕМ УСЛОВИЯ ДОСТАВКИ -->
        <div itemprop="shippingDetails" itemscope itemtype="https://schema.org/OfferShippingDetails">
            <div itemprop="shippingRate" itemscope itemtype="https://schema.org/MonetaryAmount">
                <meta itemprop="value" content="0">
                <meta itemprop="currency" content="RUB">
            </div>
            <div itemprop="shippingDestination" itemscope itemtype="https://schema.org/DefinedRegion">
                <meta itemprop="addressCountry" content="RU">
            </div>
            <div itemprop="deliveryTime" itemscope itemtype="https://schema.org/ShippingDeliveryTime">
                <div itemprop="handlingTime" itemscope itemtype="https://schema.org/QuantitativeValue">
                    <meta itemprop="minValue" content="1">
                    <meta itemprop="maxValue" content="2">
                </div>
                <div itemprop="transitTime" itemscope itemtype="https://schema.org/QuantitativeValue">
                    <meta itemprop="minValue" content="1">
                    <meta itemprop="maxValue" content="3">
                </div>
            </div>
        </div>
    </div>
</div>
                    <!-- Кнопка подробнее -->
                    <a href="{% url 'catalog:detail' product.slug %}" 
                       class="btn btn-outline-primary mt-2 w-100">
                        Подробнее
                    </a>
                </div>
            </div>
        </div>
        
        {% empty %}
        <div class="col-12">
            <div class="alert alert-info text-center">
                <h5>Товары не найдены</h5>
                <p class="mb-0">Попробуйте изменить параметры фильтрации</p>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Пагинация -->
    <div class="row mt-4">
        <div class="col-12">
            {% include "includes/paginator.html" %}
        </div>
    </div>
</div>

<!-- Дублирующая JSON-LD разметка для лучшего понимания поисковиками -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "ItemList",
  "name": "{{ seo_title|default:'Каталог компрессионного трикотажа'|escapejs }}",
  "description": "{{ seo_description|default:'Широкий выбор компрессионного трикотажа'|escapejs }}",
  "numberOfItems": {{ prod_count.id__count }},
  "itemListElement": [
    {% for product in page_obj.object_list %}
    {
      "@type": "ListItem",
      "position": {{ forloop.counter }},
      "item": {
        "@type": "Product",
        "name": "{{ product.seo_title|default:product.name|escapejs }}",
        "description": "{{ product.seo_description|default:product.name|escapejs }} - компрессионный трикотаж {{ product.brand.name }}",  {# ✅ ДОБАВЛЕНО description #}
        "url": "{{ request.scheme }}://{{ request.get_host }}{% url 'catalog:detail' product.slug %}",
        {% if product.articul %}
        "sku": "{{ product.article|escapejs }}",
        {% endif %}
        "brand": {
          "@type": "Brand",
          "name": "{{ product.brand.name|escapejs }}"
        },
        "offers": {
          "@type": "Offer",
          "price": "{{ product.price|floatformat:"2u" }}",
          "priceCurrency": "RUB",
          "availability": "https://schema.org/InStock",
          "url": "{{ request.scheme }}://{{ request.get_host }}{% url 'catalog:detail' product.slug %}",
          "hasMerchantReturnPolicy": {  {# ✅ ДОБАВЛЕНО политика возврата #}
            "@type": "MerchantReturnPolicy",
            "returnPolicyCategory": "https://schema.org/MerchantReturnFiniteReturnWindow",
            "merchantReturnDays": 14
          },
          "shippingDetails": {  {# ✅ ДОБАВЛЕНО условия доставки #}
            "@type": "OfferShippingDetails",
            "shippingRate": {
              "@type": "MonetaryAmount",
              "value": "0",
              "currency": "RUB"
            },
            "shippingDestination": {
              "@type": "DefinedRegion",
              "addressCountry": "RU"
            },
            "deliveryTime": {
              "@type": "ShippingDeliveryTime",
              "handlingTime": {
                "@type": "QuantitativeValue",
                "minValue": "1",
                "maxValue": "2"
              },
              "transitTime": {
                "@type": "QuantitativeValue", 
                "minValue": "1",
                "maxValue": "3"
              }
            }
          }
        }
        {% if product.main_images %},
        {% for image in product.main_images %}
        "image": "{{ image.image.url }}"
        {% endfor %}
        {% endif %}
      }
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
  ]
}
</script>

<style>
.filter-form .form-label {
    font-size: 0.875rem;
    font-weight: 500;
    margin-bottom: 0.25rem;
}

.filter-form select {
    font-size: 0.875rem;
    width: 100%;
    padding: 0.375rem 0.75rem;
    border: 1px solid #ced4da;
    border-radius: 0.375rem;
    background-color: white;
}

.filter-form select:focus {
    border-color: #86b7fe;
    outline: 0;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}

@media (max-width: 768px) {
    .filter-form .col-12 {
        margin-bottom: 0.5rem;
    }
}
</style>
{% endblock %}