{% extends "base.html" %}
{% load django_bootstrap5 %}
{% load static %}

{% block title %}Поиск товаров{% endblock %}

{% block content %}
<div class="container">
    <h1>Поиск товаров</h1>
    
    <!-- Форма поиска с позиционированием -->
    <div class="position-relative">  <!-- Добавляем эту обертку -->
        <form method="get" class="d-flex mb-4">
            <div class="flex-grow-1 position-relative">  <!-- И эту обертку для поля -->
                <input type="text" 
                       name="query" 
                       class="form-control" 
                       placeholder="Введите название или артикул..."
                       value="{{ query|default:'' }}"
                       id="search-input">
            </div>
            <button type="submit" class="btn btn-primary ms-2">Поиск</button>
        </form>
    </div>
    
    <!-- Результаты -->
    {% if query %}
        {% if results %}
            <h5>Найдено товаров: {{ results|length }}</h5>
            <div class="row">
                {% for product in results %}
                <div class="col-md-4 mb-4">
                    <div class="card h-100">
                        {% if product.main_images %}
                            <img src="{{ product.main_images.0.image.url }}" 
                                 class="card-img-top" 
                                 alt="{{ product.name }}"
                                 style="height: 200px; object-fit: contain;">
                        {% endif %}
                        <div class="card-body">
                            <h5 class="card-title">{{ product.name }}</h5>
                            <p class="card-text">
                                <small class="text-muted">
                                    {{ product.brand.name }} | {{ product.articul }}
                                </small>
                            </p>
                            <p class="card-text">
                                <strong>{{ product.price }} ₽</strong>
                            </p>
                            <a href="{{ product.get_absolute_url }}" class="btn btn-primary">
                                Подробнее
                            </a>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="alert alert-info">
                По запросу "{{ query }}" ничего не найдено.
            </div>
        {% endif %}
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
// Автодополнение
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('search-input');
    
    // Создаем контейнер для автодополнения
    const autocompleteContainer = document.createElement('div');
    autocompleteContainer.className = 'autocomplete-dropdown';
    autocompleteContainer.id = 'autocomplete-results';
    
    // Вставляем контейнер ПОСЛЕ поля ввода
    searchInput.parentNode.appendChild(autocompleteContainer);
    
    let currentRequest = null;
    
    // Функция для позиционирования контейнера
    function positionAutocomplete() {
        if (searchInput && autocompleteContainer) {
            // Получаем размеры и позицию поля ввода
            const inputRect = searchInput.getBoundingClientRect();
            
            // Устанавливаем позицию контейнера
            autocompleteContainer.style.position = 'absolute';
            autocompleteContainer.style.top = inputRect.height + 'px';
            autocompleteContainer.style.left = '0';
            autocompleteContainer.style.width = inputRect.width + 'px';
        }
    }
    
    // Позиционируем при загрузке и изменении размера окна
    positionAutocomplete();
    window.addEventListener('resize', positionAutocomplete);
    
    // Обработчик ввода текста
    searchInput.addEventListener('input', function() {
        const query = this.value.trim();
        
        // Отменяем предыдущий запрос
        if (currentRequest) {
            currentRequest.abort();
        }
        
        // Обновляем позицию (на случай если что-то изменилось)
        positionAutocomplete();
        
        if (query.length >= 2) {
            // Показываем индикатор загрузки
            autocompleteContainer.innerHTML = `
                <div class="autocomplete-loading">
                    <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                    Поиск...
                </div>
            `;
            autocompleteContainer.style.display = 'block';
            
            // Делаем AJAX запрос
            currentRequest = new XMLHttpRequest();
            currentRequest.open('GET', `{% url 'homepage:autocomplete' %}?term=${encodeURIComponent(query)}`);
            currentRequest.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
            
            currentRequest.onload = function() {
                if (currentRequest.status === 200) {
                    const data = JSON.parse(currentRequest.responseText);
                    autocompleteContainer.innerHTML = '';
                    
                    if (data.suggestions && data.suggestions.length > 0) {
                        data.suggestions.forEach(item => {
                            const div = document.createElement('a');
                            div.href = item.url || '#';
                            div.className = 'autocomplete-item';
                            div.innerHTML = `
                                <div class="autocomplete-item-content">
                                    <strong>${item.name || ''}</strong>
                                    ${item.brand ? `<div class="text-muted small">${item.brand}</div>` : ''}
                                    ${item.price ? `<div class="text-success small">${item.price} ₽</div>` : ''}
                                </div>
                            `;
                            autocompleteContainer.appendChild(div);
                        });
                    } else {
                        autocompleteContainer.innerHTML = `
                            <div class="autocomplete-no-results">
                                <i class="bi bi-search me-2"></i>
                                Ничего не найдено
                            </div>
                        `;
                    }
                    autocompleteContainer.style.display = 'block';
                }
            };
            
            currentRequest.onerror = function() {
                autocompleteContainer.innerHTML = `
                    <div class="autocomplete-error">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        Ошибка соединения
                    </div>
                `;
            };
            
            currentRequest.send();
        } else {
            autocompleteContainer.style.display = 'none';
        }
    });
    
    // Скрыть при клике вне
    document.addEventListener('click', function(e) {
        if (!autocompleteContainer.contains(e.target) && e.target !== searchInput) {
            autocompleteContainer.style.display = 'none';
        }
    });
    
    // Показать при фокусе на поле (если есть результаты)
    searchInput.addEventListener('focus', function() {
        if (autocompleteContainer.children.length > 0) {
            autocompleteContainer.style.display = 'block';
        }
    });
    
    // Скрыть при потере фокуса
    searchInput.addEventListener('blur', function() {
        // Небольшая задержка, чтобы можно было кликнуть на элемент автодополнения
        setTimeout(() => {
            autocompleteContainer.style.display = 'none';
        }, 200);
    });
});
</script>

<style>
/* Контейнер для автодополнения */
.autocomplete-dropdown {
    display: none;
    background: white;
    border: 1px solid #ced4da;
    border-top: none;
    border-radius: 0 0 0.375rem 0.375rem;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    max-height: 350px;
    overflow-y: auto;
    z-index: 1000;
}

/* Элементы автодополнения */
.autocomplete-item {
    display: block;
    padding: 10px 15px;
    text-decoration: none;
    color: #212529;
    border-bottom: 1px solid #f8f9fa;
    transition: background-color 0.15s;
}

.autocomplete-item:hover {
    background-color: #f8f9fa;
    text-decoration: none;
}

.autocomplete-item:last-child {
    border-bottom: none;
}

.autocomplete-item-content {
    display: flex;
    flex-direction: column;
}

/* Состояния */
.autocomplete-loading,
.autocomplete-no-results,
.autocomplete-error {
    padding: 15px;
    text-align: center;
    color: #6c757d;
    font-style: italic;
}

.autocomplete-error {
    color: #dc3545;
}

/* Убедимся, что поле ввода имеет правильные стили */
#search-input {
    position: relative;
    z-index: 1;
}

/* Для мобильных устройств */
@media (max-width: 768px) {
    .autocomplete-dropdown {
        max-height: 250px;
    }
}
</style>
{% endblock %}